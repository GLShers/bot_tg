import random
import asyncio
import time
from collections import defaultdict
from aiogram import F, Router
from aiogram.types import Message, CallbackQuery
from aiogram.filters import Command
from g4f.client import Client
import app.keyboards as kb
import app.database.requests as rq
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
import g4f 

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä–∞
nero_test_router = Router()

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
# –∫–ª—é—á - user_id, –∑–Ω–∞—á–µ–Ω–∏–µ - –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
last_processed_time = defaultdict(float)
# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–π –º–µ–¥–∏–∞-–≥—Ä—É–ø–ø—ã
last_media_group = defaultdict(str)
# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –º–µ–¥–∏–∞-–≥—Ä—É–ø–ø—ã
media_group_text = defaultdict(dict)
# –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –æ–±—Ä–∞–±–æ—Ç–∫–∞–º–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
MIN_PROCESS_INTERVAL = 5  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –±–æ–ª—å—à–∏—Ö –∞–ª—å–±–æ–º–æ–≤

# –ö–ª–∞—Å—Å —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–ª—è FSM
class Rega(StatesGroup):
    waait = State()

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º—Ç–∞ –¥–ª—è –Ω–µ–π—Ä–æ—Å–µ—Ç–∏
def generate_prompt(post_text):
    # –í—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å —Ç–µ–∫—Å—Ç–æ–º, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –º–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç
    prompt = (
        f"–¢—ã –æ–±—ã—á–Ω–∞—è –¥–µ–≤—É—à–∫–∞ 20-35 –ª–µ—Ç, –∫–æ—Ç–æ—Ä–∞—è –ø–∏—à–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ Telegram-–∫–∞–Ω–∞–ª–∞—Ö. "
        f"–í–ê–ñ–ù–û: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ—Ö–æ–∂–∏–º –Ω–∞ —Ç–µ, —á—Ç–æ –ø–∏—à—É—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –ª—é–¥–∏. "
        f"–í–æ—Ç –ø—Ä–∞–≤–∏–ª–∞, –∫–æ—Ç–æ—Ä—ã–º —Ç—ã –¥–æ–ª–∂–Ω–∞ —Å–ª–µ–¥–æ–≤–∞—Ç—å: "
        f"1. –ò—Å–ø–æ–ª—å–∑—É–π –∂–∏–≤–æ–π –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —è–∑—ã–∫. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç–æ –∏ –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ, –∫–∞–∫ –±—É–¥—Ç–æ –±—ã—Å—Ç—Ä–æ –ø–µ—á–∞—Ç–∞–µ—à—å –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ. "
        f"2. –ü–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ - 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º. –î–ª–∏–Ω–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤—ã–≥–ª—è–¥—è—Ç –Ω–µ–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ. "
        f"3. –î–æ–±–∞–≤–ª—è–π —ç–º–æ–¥–∂–∏, –Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ (0-2 —ç–º–æ–¥–∂–∏ –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π). "
        f"4. –ò–Ω–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π –º–Ω–æ–≥–æ—Ç–æ—á–∏—è, —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è (–Ω–æ—Ä–º, —á–µ, —Å–ø—Å), –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞–∫–∏! "
        f"5. –ò–∑—Ä–µ–¥–∫–∞ –¥–µ–ª–∞–π –æ–ø–µ—á–∞—Ç–∫–∏, –Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º –æ—á–µ–≤–∏–¥–Ω—ã–µ –∏ –Ω–µ –≤ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏. "
        f"6. –ú–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ–º–Ω—ã–µ —Ñ—Ä–∞–∑—ã, –º–æ–ª–æ–¥–µ–∂–Ω—ã–π —Å–ª–µ–Ω–≥. "
        f"7. –ù–ï –ø–∏—à–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ñ—Ä–∞–∑ —Ç–∏–ø–∞ '–æ—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ', '–∫–∞–∫ –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ', '–≤–∞—É, –≤–ø–µ—á–∞—Ç–ª—è–µ—Ç'. "
        f"8. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—ã '—Å–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é', '–∫–ª–∞—Å—Å', '—Å—É–ø–µ—Ä' - –æ–Ω–∏ —Å—Ä–∞–∑—É –≤—ã–¥–∞—é—Ç –±–æ—Ç–∞. "
        f"9. –ù–ï –ø–∏—à–∏ —Ñ—Ä–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç –∏–ª–∏ –æ—Ü–µ–Ω–∏–≤–∞—é—Ç —á—Ç–æ-—Ç–æ - —Ç–∞–∫–∏–µ –æ–±–æ–±—â–µ–Ω–∏—è –≤—ã–¥–∞—é—Ç –ò–ò. "
        f"10. –ù–∏–∫–∞–∫–∏—Ö –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –∏ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ –∞–≤—Ç–æ—Ä—É. "
        f"11. –†–µ–∞–≥–∏—Ä—É–π –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å. "
        
        f"–í–æ—Ç –ø—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: "
        f"- –±–ª–∏–Ω, —Ä–µ–∞–ª—å–Ω–æ —Ç–∞–∫ –∏ –µ—Å—Ç—å( "
        f"- –∫–∞–∫ –∂–µ –∑–∞—Ö–æ—Ç–µ–ª–æ—Å—å —Ç–µ–ø–µ—Ä—å —ç—Ç–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å... üôà "
        f"- –Ω—É –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ –∫—Ç–æ-—Ç–æ —ç—Ç–æ —Å–∫–∞–∑–∞–ª "
        f"- —É –º–µ–Ω—è —Ç–æ—á–Ω–æ —Ç–∞–∫–∞—è –∂–µ —Ñ–∏–≥–Ω—è –±—ã–ª–∞ –≤ –ø—Ä–æ—à–ª–æ–º –≥–æ–¥—É "
        f"- –≤–æ—Ç –∂–µ–∂ –∫–∞–∫ –±—ã–≤–∞–µ—Ç... "
        f"- –±–æ–º–±–∞ üî• "
        f"- —á–µ—Ç —è —Ä–∂—É)) "
        
        f"–í–æ—Ç –ø—Ä–∏–º–µ—Ä—ã –ü–õ–û–•–ò–•, –Ω–µ–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (–ù–ï –ò–°–ü–û–õ–¨–ó–£–ô): "
        f"- '–û—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –∏ –ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å–Ω–æ!' "
        f"- '–ö–∞–∫–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞, –ø—Ä—è–º –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç!' "
        f"- '–£—Ö —Ç—ã, –∫–∞–∫ –∫–ª–∞—Å—Å–Ω–æ! –≠—Ç–æ –ø–æ–¥–Ω–∏–º–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ!' "
        f"- '–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –æ—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω–æ!' "
        
        f"---\n{post_text}\n---\n"
        
        f"–ù–∞–ø–∏—à–∏ –¢–û–õ–¨–ö–û –û–î–ò–ù –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π, –∫–æ—Ä–æ—Ç–∫–∏–π, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π, –±—É–¥—Ç–æ –µ–≥–æ –Ω–∞–ø–∏—Å–∞–ª–∞ —Ä–µ–∞–ª—å–Ω–∞—è –¥–µ–≤—É—à–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—ã—Å—Ç—Ä–æ –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª–∞ –Ω–∞ –ø–æ—Å—Ç. "
        f"–ù–ï —Å—Ç—Ä–µ–º–∏—Å—å –±—ã—Ç—å –≤–µ–∂–ª–∏–≤–æ–π –∏–ª–∏ –∫—É–ª—å—Ç—É—Ä–Ω–æ–π - –ø–∏—à–∏ —Ç–∞–∫, –∫–∞–∫ –ø–∏—à—É—Ç –ª—é–¥–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ. "
        f"–í–ù–ò–ú–ê–ù–ò–ï: –µ—Å–ª–∏ –ø–æ—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —á—Ç–æ-—Ç–æ —Å–≤—è–∑–∞–Ω–Ω–æ–µ —Å –Ω–∞—Ä–∫–æ—Ç–∏–∫–∞–º–∏, –æ—Ä—É–∂–∏–µ–º, –ø–æ–ª–∏—Ç–∏–∫–æ–π, –Ω–∞—Å–∏–ª–∏–µ–º, –≤–æ–π–Ω–æ–π, –£–∫—Ä–∞–∏–Ω–æ–π –∏–ª–∏ –¥—Ä—É–≥–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —Å–ø–æ—Ä–Ω—ã–µ/—Å–µ–Ω—Å–∏—Ç–∏–≤–Ω—ã–µ —Ç–µ–º—ã - –ù–ï –ø–∏—à–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, "
        f"–∞ –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –Ω–∞–ø–∏—à–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –º–µ—Ç–∫—É: '[–°–ï–ù–°–ò–¢–ò–í–ù–´–ô_–ö–û–ù–¢–ï–ù–¢]'. –≠—Ç–∞ –º–µ—Ç–∫–∞ –±—É–¥–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–æ–π."
    )
    return prompt

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /run_bot
@nero_test_router.callback_query(F.data.startswith("test"))
async def com_start(callback: CallbackQuery, state: FSMContext):
    await callback.message.edit_text(
        "<b>üîç –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –Ω–µ–π—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏–Ω–≥–∞</b>\n\n"
        "–°–µ–π—á–∞—Å –≤—ã –º–æ–∂–µ—Ç–µ —É–≤–∏–¥–µ—Ç—å, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–º–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.\n\n"
        "<b>üì± –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b>\n"
        "1Ô∏è‚É£ –ü–µ—Ä–µ—à–ª–∏—Ç–µ —Å—é–¥–∞ –ø–æ—Å—Ç –∏–∑ –ª—é–±–æ–≥–æ –∫–∞–Ω–∞–ª–∞\n"
        "2Ô∏è‚É£ –ù–∞—à–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ\n"
        "3Ô∏è‚É£ –í—ã —É–≤–∏–¥–∏—Ç–µ –ø—Ä–∏–º–µ—Ä –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è, –∫–æ—Ç–æ—Ä—ã–π –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –±–æ—Ç\n\n"
        "<i>–ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—à–ª–∏—Ç–µ —Å—é–¥–∞ –ª—é–±–æ–π –ø–æ—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–±–Ω–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è</i>",
        parse_mode="HTML", 
        reply_markup=kb.main_button()
    )
    await state.set_state(Rega.waait)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
@nero_test_router.message(Rega.waait)
async def process_link(message: Message, state: FSMContext):
    user_id = message.from_user.id
    current_time = time.time()
    has_text = bool(message.text or message.caption)
    
    # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é –º–µ–¥–∏–∞-–≥—Ä—É–ø–ø—ã
    if message.media_group_id:
        # –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –≥—Ä—É–ø–ø—ã, –∫–æ—Ç–æ—Ä–æ–µ –º—ã –≤–∏–¥–∏–º
        if message.media_group_id not in media_group_text.get(user_id, {}):
            media_group_text.setdefault(user_id, {})[message.media_group_id] = {
                'has_message_with_text': has_text,
                'text': message.text or message.caption or '',
                'first_message': message,
                'time': current_time
            }
        # –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –≥—Ä—É–ø–ø—ã
        else:
            group_data = media_group_text[user_id][message.media_group_id]
            # –ï—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–º–µ–µ—Ç —Ç–µ–∫—Å—Ç, –∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –Ω–µ—Ç - –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            if has_text and not group_data['has_message_with_text']:
                group_data['has_message_with_text'] = True
                group_data['text'] = message.text or message.caption
                group_data['first_message'] = message  # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Ç–æ, –∫–æ—Ç–æ—Ä–æ–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç
            
            # –ï—Å–ª–∏ —Å –º–æ–º–µ–Ω—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã –ø—Ä–æ—à–ª–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –º—ã –Ω–∞—à–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º
            if current_time - group_data['time'] > 2 and group_data['has_message_with_text']:
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ –µ—â–µ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–æ—Å—å
                if message.media_group_id != last_media_group.get(user_id):
                    last_media_group[user_id] = message.media_group_id
                    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
                    if current_time - last_processed_time.get(user_id, 0) > MIN_PROCESS_INTERVAL:
                        last_processed_time[user_id] = current_time
                        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º –∏–∑ –≥—Ä—É–ø–ø—ã
                        await process_message_content(group_data['first_message'], state, group_data['text'])
                return  # –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ –≤—ã—Ö–æ–¥–∏–º, —á—Ç–æ–±—ã –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –≥—Ä—É–ø–ø—ã
            
            # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∂–¥–∞—Ç—å, –º–æ–∂–µ—Ç –ø–æ—è–≤–∏—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º
            return
    
    # –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞/–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    if current_time - last_processed_time.get(user_id, 0) < MIN_PROCESS_INTERVAL:
        print(f"–ò–≥–Ω–æ—Ä–∏—Ä—É—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} - –∏–Ω—Ç–µ—Ä–≤–∞–ª —Å–ª–∏—à–∫–æ–º –º–∞–ª")
        return
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–¥–∏–Ω–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    last_processed_time[user_id] = current_time
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É
    post_text = message.text or message.caption or "–ü–æ—Å—Ç –±–µ–∑ —Ç–µ–∫—Å—Ç–∞"
    await process_message_content(message, state, post_text)

# –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
async def process_message_content(message, state, post_text):
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    status_message = await message.answer(
        "<b>‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...</b>",
        parse_mode="HTML"
    )
    
    user = await rq.get_user_data(message.from_user.id)

    if not user:
        await status_message.edit_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.")
        return
    
    description_chanel = user.my_chanel_description if hasattr(user, 'my_chanel_description') else None
    
    if not description_chanel:
        await status_message.edit_text(
            "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –∫–∞–Ω–∞–ª–∞!\n\n"
            "–î–ª—è —Ä–∞–±–æ—Ç—ã –Ω–µ–π—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏–Ω–≥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –≤ –≤–∞—à–µ–º –ø—Ä–æ—Ñ–∏–ª–µ."
        )
        return

    if len(post_text) > 1500:
        await status_message.edit_text(
            "‚ùå –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ç–µ–∫—Å—Ç!\n\n"
            "–í —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ —Ä–∞–±–æ—Ç–∞–µ–º —Å —Ç–µ–∫—Å—Ç–∞–º–∏ –¥–æ 1500 —Å–∏–º–≤–æ–ª–æ–≤."
        )
        return
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç
    await status_message.edit_text(
        "<b>üß† –ù–µ–π—Ä–æ—Å–µ—Ç—å –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞...</b>\n\n"
        "–≠—Ç–æ –∑–∞–π–º–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.",
        parse_mode="HTML"
    )
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—Å—Ç–∞
    prompt = generate_prompt(post_text)

    try:
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º –∫ GPT
        await asyncio.sleep(1.5)  # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –±–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ –æ—â—É—â–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã
        await status_message.edit_text(
            "<b>‚ú® –°–æ–∑–¥–∞—é –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...</b>",
            parse_mode="HTML"
        )
        
        response = await g4f.ChatCompletion.create_async(
            model="deepseek-v3",
            messages=[
                {"role": "system", "content": "You are a business man."},
                {"role": "user", "content": prompt}
            ]
        )
        
        print("–û—Ç–≤–µ—Ç GPT:", response)

        comment = response if isinstance(response, str) else "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –æ—Ç–≤–µ—Ç –º–µ—Ç–∫—É –æ —Å–µ–Ω—Å–∏—Ç–∏–≤–Ω–æ–º –∫–æ–Ω—Ç–µ–Ω—Ç–µ
        if "[–°–ï–ù–°–ò–¢–ò–í–ù–´–ô_–ö–û–ù–¢–ï–ù–¢]" in comment or comment == "..." or comment.strip() == "":
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Å–µ–Ω—Å–∏—Ç–∏–≤–Ω–æ–º –∫–æ–Ω—Ç–µ–Ω—Ç–µ
            await status_message.edit_text(
                "<b>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!</b>\n\n"
                "–í–∞—à –ø–æ—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç <b>—Å–µ–Ω—Å–∏—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</b> (–ø–æ–ª–∏—Ç–∏–∫–∞, –Ω–∞—Å–∏–ª–∏–µ, –æ—Ä—É–∂–∏–µ –∏ —Ç.–ø.).\n\n"
                "–°–æ–≥–ª–∞—Å–Ω–æ –Ω–∞—à–∏–º –ø—Ä–∞–≤–∏–ª–∞–º —Å–µ—Ä–≤–∏—Å–∞, –º—ã –Ω–µ –º–æ–∂–µ–º –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è —Ç–∞–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥–æ–π –ø–æ—Å—Ç –∏–ª–∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
                parse_mode="HTML",
                reply_markup=kb.sensitive_content_keyboard()  # –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏
            )
        else:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
            await status_message.edit_text(
                f"<b>‚úÖ –ì–æ—Ç–æ–≤–æ! –ü—Ä–∏–º–µ—Ä –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:</b>\n\n"
                f"<i>\"{comment}\"</i>",
                parse_mode="HTML"
            )

            # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏
            await message.answer(
                "üî• <b>–í–ø–µ—á–∞—Ç–ª—è–µ—Ç, –ø—Ä–∞–≤–¥–∞?</b>\n\n"
                "–≠—Ç–æ –ª–∏—à—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –Ω–µ–π—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏–Ω–≥–∞. –° –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π –±–æ—Ç –±—É–¥–µ—Ç:\n\n"
                "‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã 24/7\n"
                "‚Ä¢ –°–æ—Å—Ç–∞–≤–ª—è—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å —É—á–µ—Ç–æ–º —Ç–µ–º–∞—Ç–∏–∫–∏\n"
                "‚Ä¢ –ü—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∏—Ö –æ—Ç –∏–º–µ–Ω–∏ –Ω–∞—à–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ —Å –≤–∞—à–µ–π —Å—Å—ã–ª–∫–æ–π –Ω–∞ –∫–∞–Ω–∞–ª\n"
                "‚Ä¢ –ü—Ä–∏–≤–ª–µ–∫–∞—Ç—å –Ω–æ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é –Ω–∞ –≤–∞—à –∫–∞–Ω–∞–ª\n\n"
                "<b>üíé –û–¥–∏–Ω –±–æ—Ç –∑–∞–º–µ–Ω—è–µ—Ç —Ü–µ–ª—É—é –∫–æ–º–∞–Ω–¥—É –∫–æ–º–º–µ–Ω—Ç–∞—Ç–æ—Ä–æ–≤!</b>",
                parse_mode="HTML",
                reply_markup=kb.subscription_offer_keyboard()
            )

    except Exception as e:
        await status_message.edit_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: {e}")
        
    finally:
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        await state.clear()